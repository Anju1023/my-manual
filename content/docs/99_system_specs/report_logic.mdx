---
title: '帳票出力マクロの仕様'
description: 製造数集計やラベル表作成など、主要な帳票出力マクロの内部ロジック解説です。
---

import { Callout } from 'fumadocs-ui/components/callout';
import { Accordion, Accordions } from 'fumadocs-ui/components/accordion';
import { Step, Steps } from 'fumadocs-ui/components/steps';
import {
	FileText,
	Calculator,
	Database,
	ArrowRight,
	SquareCode,
	Factory,
	Croissant,
	ShoppingCart,
} from 'lucide-react';

# <SquareCode className='inline w-[1em] h-[1em] mr-1 -mt-1' /> 帳票出力マクロの仕様 (Report Logic)

操作シートのボタンから呼び出される、各帳票作成マクロの内部ロジックを解説します。
すべてのマクロは、処理速度向上のため `Application.ScreenUpdating = False`（画面更新停止）を使用し、`frmProgress` フォームで進捗状況を表示する共通仕様となっています。

## <Factory className='inline w-[1em] h-[1em] mr-1 -mt-1' /> 製造数・集計系マクロ

各店舗のシートからデータを収集し、集計シート（`CB製造数` 等）に書き出す処理です。

<Accordions>
   <Accordion title="CB製造数合計出力 / クリエイト製造数合計出力" icon={<Calculator />}>
      **概要:**
      全店舗（またはクリエイト納品分）の製造数を商品ごとに合算します。

      **処理ロジック:**
      <Steps>
         <Step>
            ### 対象シートの特定
            `先頭` シートから `末尾` シート（または `クリエ先頭` 〜 `クリエ末尾`）の間にあるシートをループ処理します。\
            `A列5行目` 以降にデータがあるシートのみを集計対象とします。
         </Step>
         <Step>
            ### ディクショナリ集計
            `Scripting.Dictionary` を使用し、キーを「商品名」として集計します。\
            各シートの `3列目(月)` 〜 `16列目(日)` の値を加算していきます。
         </Step>
         <Step>
            ### 出力
            集計結果を `CB製造数`（または `クリエ製造数`）シートに出力します。\
            最後に、縦計（日別合計）と横計（商品別合計）の整合性チェックを行います。
         </Step>
      </Steps>

   </Accordion>
   <Accordion title="消費期限チェック表出力 (ラベル出し)" icon={<FileText />}>
      **概要:**\
      ラベラー担当者が使用する、消費期限と個数のチェックリストを作成します。

      **処理ロジック:**
      <Steps>
         <Step>
            ### データソース
            集計済みの `CB製造数` シートを参照します。
         </Step>
         <Step>
            ### 期限計算
            `商品データ` テーブルの `期限` 列を参照します。

            ### 特例ロジック
            期限が `1日` 以下の場合は、ラベル作成上の都合により `+1` (翌日) として計算します。
         </Step>
         <Step>
            ### クラスモジュールの使用
            `ClsLabel` クラスを使用し、曜日ごとの個数と期限情報をオブジェクトとして保持・整理します。
         </Step>
         <Step>
            ### 表示制御
            1週間分の合計数量が `0` の商品は、リストから除外されます。
         </Step>
      </Steps>

   </Accordion>

</Accordions>

## <Croissant className='inline w-[1em] h-[1em] mr-1 -mt-1' /> 工程表作成マクロ (生地・成形)

製造スタッフが使用する「生地出し表」や「並べる表」を作成する処理です。
商品マスタの設定値 (`Frozen`, `Display` 等) に基づいて振り分けられます。

<Callout
	type="info"
	title="共通: 親名称での集計 (GetBaseName)"
	icon={<Database />}
>
	集計時、商品名のサイズ表記（「1/2」「1本」など）を削除し、**「親名称」で合算**
	しています。 
    
    * 例: `プレミアム食パン` と `プレミアム食パン 1/2` ➔ **`プレミアム食パン`** として合計数を計算

</Callout>

<Accordions>
    <Accordion title="冷凍生地出し / スクラッチ生地出し" icon={<Calculator />}>
        **計算ロジック:**
        
        * **必要生地数:** `製造数` × `何個入` × `生地数` (切り上げ)
        * **日付シフト:** `納品日` - `生地出し日数(FrozenDaysBefore)`
          * 納品日から逆算して、解凍や仕込みが必要な日付に数量を計上します。
    </Accordion>
    <Accordion title="並べる表出力" icon={<Calculator />}>
        **計算ロジック:**

        * **並べる総数:** `製造数` × `何個入`
        * **天板枚数の算出 (`NarabeSingle`関数):**
          * マスタの `最大数(MaxQty)` と `倍数(Multiple)` を使用して計算します。
          * 例: 「5個ずつ並べて、1枚に最大20個」の場合 ➔ 「〇枚 × 20個、1枚 × 15個」のような文字列を生成します。
    </Accordion>

</Accordions>

## <ShoppingCart className='inline w-[1em] h-[1em] mr-1 -mt-1' /> 発注・納品系マクロ

<Accordions>
   <Accordion title="商品別シート出力 (ローゼン / クリエイト)" icon={<FileText />}>
      **概要:**
      店舗ごとの仕分けリストを作成し、**新しいブックとして保存** します。

      **特記事項:**

      - **保存先:** `CB商品データ.xlsm` と同じフォルダ内の `\商品ごとの表\` フォルダ。
      - **並び替え:** データの取得順ではなく、**店舗マスターの「店舗番号」順** に並び替えるソート処理が実装されています。

   </Accordion>
   <Accordion title="発注表作成 & 仕入先別出力" icon={<ArrowRight />}>
   **処理フロー:**

      <Steps>
         <Step>
            ### 所要量計算
            `製造数` シートの合計 × `レシピ` テーブルの「使用量」
         </Step>
         <Step>
            ### 発注数算出
            総所要量 ÷ `材料マスター` の「入数」 (切り上げ)
         </Step>
         <Step>
            ### 帳票出力
            まず `発注` シートに一覧を出力。\
            その後、`仕入先別発注表` シートに、仕入先ごとのブロックに分けて転記します。
         </Step>

      </Steps>

   </Accordion>

</Accordions>
